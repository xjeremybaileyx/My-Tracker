<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nutrition & Med Tracker</title>
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { -webkit-tap-highlight-color: transparent; background-color: #f8fafc; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .modal-open { overflow: hidden; }
    </style>
</head>
<body class="p-4 pb-24">
    <div id="app" class="max-w-md mx-auto">
        <div class="flex justify-between items-center mb-6">
            <h1 id="appTitle" class="text-2xl font-bold text-slate-800">Nutrition Tracker</h1>
            <button onclick="toggleModal('profileModal')" class="bg-slate-200 p-2 rounded-full">⚙️</button>
        </div>

        <input type="date" id="datePicker" onchange="render()" class="w-full mb-6 p-3 rounded-xl border-none shadow-sm font-semibold text-slate-600 bg-white">

        <div class="grid grid-cols-2 gap-4 mb-4">
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                <p class="text-xs text-slate-500 font-bold uppercase">Calories</p>
                <p class="text-xl font-black text-orange-500"><span id="calCurrent">0</span> / <span id="calGoalDisplay">2000</span></p>
                <div class="w-full bg-slate-100 h-2 rounded-full mt-2"><div id="calBar" class="bg-orange-500 h-2 rounded-full transition-all" style="width: 0%"></div></div>
            </div>
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                <p class="text-xs text-slate-500 font-bold uppercase">Protein (g)</p>
                <p class="text-xl font-black text-blue-500"><span id="proCurrent">0</span> / <span id="proGoalDisplay">150</span></p>
                <div class="w-full bg-slate-100 h-2 rounded-full mt-2"><div id="proBar" class="bg-blue-500 h-2 rounded-full transition-all" style="width: 0%"></div></div>
            </div>
        </div>

        <div class="bg-emerald-50 p-4 rounded-2xl mb-4 border border-emerald-100 text-emerald-900">
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-xs font-bold uppercase opacity-70">Injection Log</p>
                    <p id="latestInjection" class="text-sm font-bold">No injections today</p>
                </div>
                <button onclick="toggleModal('injectionModal')" class="bg-emerald-600 text-white px-4 py-2 rounded-xl text-sm font-bold">Log Dose</button>
            </div>
        </div>

        <div class="bg-cyan-50 p-4 rounded-2xl mb-4 border border-cyan-100">
            <div class="flex justify-between items-center mb-2">
                <h3 class="font-bold text-cyan-800 uppercase text-xs">Water Intake</h3>
                <span class="text-cyan-600 font-bold" id="waterProgress">0 / 0 oz</span>
            </div>
            <div class="flex gap-2">
                <button onclick="addWater(8)" class="flex-1 bg-white border border-cyan-200 py-2 rounded-lg text-xs font-bold text-cyan-700">+8oz</button>
                <button onclick="addWater(16)" class="flex-1 bg-white border border-cyan-200 py-2 rounded-lg text-xs font-bold text-cyan-700">+16oz</button>
                <button onclick="addWater(24)" class="flex-1 bg-white border border-cyan-200 py-2 rounded-lg text-xs font-bold text-cyan-700">+24oz</button>
            </div>
        </div>

        <div class="bg-indigo-50 p-4 rounded-2xl mb-6 border border-indigo-100 text-indigo-900">
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-xs font-bold uppercase opacity-70">Weight: <span id="weightDisplay">--</span> lbs</p>
                    <p class="text-xs font-medium">Goal: <span id="targetWeightDisplay">--</span> (<span id="weightToGoal">--</span>)</p>
                </div>
                <button onclick="toggleModal('weightModal')" class="bg-indigo-500 text-white px-4 py-2 rounded-xl text-sm font-bold">Log Weight</button>
            </div>
        </div>

        <div class="space-y-3 mb-24" id="mealList"></div>

        <button onclick="toggleModal('mealModal')" class="fixed bottom-6 right-6 w-16 h-16 bg-slate-900 text-white rounded-full shadow-2xl text-3xl flex items-center justify-center">＋</button>
    </div>

    <div id="mealModal" class="hidden fixed inset-0 bg-black/50 flex items-end sm:items-center justify-center p-4 z-50">
        <div class="bg-white w-full max-w-md rounded-3xl p-6 overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Add Food</h2>
                <button onclick="toggleModal('mealModal')" class="text-2xl">×</button>
            </div>
            <p class="text-xs font-bold text-slate-400 mb-2 uppercase">Library</p>
            <div id="foodLibraryGrid" class="grid grid-cols-2 gap-2 mb-4 max-h-40 overflow-y-auto border-b pb-4"></div>
            <form id="mealForm" onsubmit="saveMeal(event)" class="space-y-4">
                <input type="text" id="foodName" placeholder="Food Name" class="w-full p-3 bg-slate-100 rounded-xl" required>
                <div class="flex gap-4">
                    <input type="number" id="foodCals" placeholder="Cals" class="w-1/2 p-3 bg-slate-100 rounded-xl" required>
                    <input type="number" id="foodPro" placeholder="Protein (g)" class="w-1/2 p-3 bg-slate-100 rounded-xl" required>
                </div>
                <button type="submit" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold">Log Entry</button>
                <button type="button" onclick="addToLibrary()" class="w-full border-2 border-slate-900 py-2 rounded-2xl font-bold text-sm">Save to Library</button>
            </form>
        </div>
    </div>

    <div id="injectionModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
        <div class="bg-white w-full max-w-md rounded-3xl p-6 overflow-y-auto max-h-[90vh]">
            <h2 class="text-xl font-bold mb-4">Log Injection</h2>
            <form onsubmit="saveInjection(event)" class="space-y-3">
                <input type="text" id="injName" placeholder="Drug Name (e.g. B12)" class="w-full p-3 bg-slate-100 rounded-xl" required>
                <div class="flex gap-2">
                    <input type="number" step="0.01" id="injMg" placeholder="Dose (mg)" class="w-1/2 p-3 bg-slate-100 rounded-xl" required>
                    <input type="number" step="0.01" id="injMl" placeholder="Total (cc/ml)" class="w-1/2 p-3 bg-slate-100 rounded-xl" required>
                </div>
                <button type="submit" class="w-full bg-emerald-600 text-white py-4 rounded-2xl font-bold">Record Injection</button>
            </form>
            <div id="injectionHistory" class="mt-4 space-y-2"></div>
            <button onclick="toggleModal('injectionModal')" class="w-full text-slate-400 text-sm font-bold mt-4">Close</button>
        </div>
    </div>

    <div id="profileModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
        <div class="bg-white w-full max-w-md rounded-3xl p-6">
            <h2 class="text-xl font-bold mb-4 text-center">Profile & Goals</h2>
            <div class="space-y-4">
                <input type="text" id="userNameInput" placeholder="Name" class="w-full p-3 bg-slate-100 rounded-xl">
                <input type="number" id="goalCalsInput" placeholder="Calorie Goal" class="w-full p-3 bg-slate-100 rounded-xl">
                <input type="number" id="goalProInput" placeholder="Protein Goal" class="w-full p-3 bg-slate-100 rounded-xl">
                <input type="number" id="goalWeightInput" placeholder="Target Weight" class="w-full p-3 bg-slate-100 rounded-xl">
                <button onclick="saveProfile()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold">Save Changes</button>
                <button onclick="toggleModal('profileModal')" class="w-full text-slate-400 text-sm font-bold">Close</button>
            </div>
        </div>
    </div>

    <div id="weightModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
        <div class="bg-white w-full max-w-md rounded-3xl p-6">
            <h2 class="text-xl font-bold mb-4">Log Today's Weight</h2>
            <input type="number" id="weightInput" step="0.1" class="w-full p-3 bg-slate-100 rounded-xl mb-4" placeholder="0.0 lbs">
            <button onclick="saveWeight()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold">Save Weight</button>
            <button onclick="toggleModal('weightModal')" class="w-full text-slate-400 text-sm font-bold mt-2">Cancel</button>
        </div>
    </div>

    <script>
        let state = JSON.parse(localStorage.getItem('nutritionAppData')) || {
            user: { name: "", calorieGoal: 2000, proteinGoal: 150, targetWeight: 150 },
            days: {},
            library: [
                { name: "Chicken Breast", cal: 165, pro: 31 },
                { name: "Eggs (2)", cal: 140, pro: 12 },
                { name: "Greek Yogurt", cal: 100, pro: 18 }
            ]
        };

        function saveToStorage() { localStorage.setItem('nutritionAppData', JSON.stringify(state)); render(); }
        function toggleModal(id) { document.getElementById(id).classList.toggle('hidden'); fillInputs(); }
        
        const datePicker = document.getElementById('datePicker');
        if(!datePicker.value) datePicker.value = new Date().toISOString().split('T')[0];

        function getDayData() {
            const d = datePicker.value;
            if (!state.days[d]) state.days[d] = { meals: [], water: 0, injections: [] };
